# 에러 및 정리

> 게시판 만들면서 발생한 에러나 잘 몰랐던 내용을 정리한 파일



## 에러

```
Is the server running on host "localhost" (127.0.0.1) and accepting
TCP/IP connections on port 5432?
```

[에러] `./manage.py runserver`를 하면 위와 같은 에러가 발생

[해결] [이곳](https://stackoverflow.com/questions/37307346/is-the-server-running-on-host-localhost-1-and-accepting-tcp-ip-connections)을 참조하여 PostgreSQL 설치로 해결



```
null value in column "author_id" violates not-null constraint
```

`[에러]` 새로운 포스트를 만들려고 했을 때 발생

`[해결]`  Post 모델에서 author 필드가 `blank=True null=True`가 아니기에 해당 로그인한 유저의 정보를 같이 줘야 함

```python
if form.is_valid():
    post = form.save(commit=False)
    post.author = request.user
    post.save()
```



```
Unsafe redirect to URL with protocol 'posts'
```

[에러] `return redirect('posts:post_list.html')` 입력을 하면서 위 에러가 발생

[해결] `return redirect('posts:post_list')` 로 해결



```python
# views.py
def logout(request):
    if request.method == 'POST':
        logout(request)
        return redirect('posts:post_list')
    
# base.html
{% raw %}
{% if user.is_authenticated %}
    <form action="" method="POST">
    {% csrf_token %}
    <li><a href="{% url 'members:logout' %}">로그아웃</a></li>
    </form>
{% endif %}
{% endraw %}
```

[에러] `The view members.views.logout didn't return an HttpResponse object. It returned None instead.` 

[해결] `<li><button type="submit">로그아웃</button></li>` 



```
The given username must be set
```

[에러] 회원가입하면 에러 발생. 디버그 모드로 실행하면 회원가입은 잘 됨

**[미해결]** 갑자기 잘 됨. 확인 필요



## 정리

##### .get('search', '')

```python
def post_list(request):
    posts = Post.objects.all()
    search= request.GET.get('search', '')
    if search:
        posts = posts.filter(title__icontains=search)
    context = {
        'posts': posts,
        'search': search,

    }
    return render(request, 'posts/post_list.html', context)
```

The `request` object contains information about the user's request. What data they've sent to the page, where they are coming from, etc. `request.GET` contains the GET variables. These are what you see in your browser's address bar. The `.get()` method is a method used for dictionaries. What your snippet of code is doing is saying, "Get the value of a GET variable with name 'page', and if it doesn't exist, return 1". Likewise, you will see `request.POST` used when a user submits a form. 라고 [스택 오버 플로우](https://stackoverflow.com/questions/44598962/what-does-request-get-get-means)에 답변이 달려있다. 유저가 검색창에 무언가를 입력한다면 `search`에 그 무언가가 들어가게 되지만, 그렇지 않다면 두 번째  `''` 값이 들어가게 된다.

##### 로그인한 유저만 특정 내용을 볼 수 있도록 하기

```
{% raw %}
{% if user.is_authenticated %}
    content 
{% endif %}
{% endraw %}
```

로그인한 유저만 글을 작성한다, 수정한다와 같은 경우일 때 사용하면 된다.



##### Pagination

```python
# 수정 전 views.py
def post_list(request):
    posts = Post.objects.all()
    <생략>
    return render(request, 'posts/post_list.html', context)

# 수정 후 views.py
def post_list(request):
    posts = Post.objects.all()
    # Show 15 posts per page
    paginator = Paginator(posts, 15)
    page = request.GET.get('page')
    posts = paginator.get_page(page)
    <생략>
    return render(request, 'posts/post_list.html', context)
```

**가장 큰 문제**는 특정 글에서 글목록을 누르면 해당 글이 위치한 페이지로 돌아가야 하는 것이다. 몇 시간에 걸쳐 페이스북 `Ask Django` 에서 발견했다. `request.META.get('HTTP_REFERER')` 이걸 이용하면 이전 URL을 가져온다.

```python
# 수정 전 views.py
def post_detail(request, pk):
    post = get_object_or_404(Post, id=pk)
    # 조회수 증가
    post.update_view_count
    context = {
        'post': post,
        'before_url': before_url
    }
    return render(request, 'posts/post_detail.html', context)

# 수정 후 views.py
def post_detail(request, pk):
    post = get_object_or_404(Post, id=pk)

    # 이전에 위치한 주소를 가져오기
    before_url = request.META.get('HTTP_REFERER')

    # 조회수 증가
    post.update_view_count
    context = {
        'post': post,
        'before_url': before_url
    }
    return render(request, 'posts/post_detail.html', context)
```

문제점도 있는데 바로 특정 글로 이동하고 글 목록을 누르면 `Page not found (404)` 에러가 발생한다.

```html
{% raw %}
{% for i in posts.paginator.page_range %}
{% if posts.number == i %}
	<!-- [1] -->
    <li class="active"><span>{{ i }} <span class="sr-only">(current)</span></span></li>
{% else %}
	<!-- [2] -->
    <li><a href="?page={{ i }}">{{ i }}</a></li>
{% endif %}
{% endfor %}
{% endraw %}
```

**[1]** 어느 페이지에 있는지 표시해줌

**[2]** 선택한 페이지로 이동



```html
<!-- base.html -->
.pagination {
    display: flex;
    padding-left: 0px;
    list-style: none;
    border-radius: 0.25rem;
    justify-content: center;
}

<!-- post_list.html -->
<div class="container">
    생략
    ...
    <div class="col-sm-12">
        생략
        ...
        <ul class="pagination justify-content-center">
            페이지 코드
            ...
        </ul>
    </div>
</div>
```

페이지네이션이 가운데로 위치하지 않는다면 [이곳](https://jsfiddle.net/r9z25u06/)을 참조하여 코드를 고쳐보자